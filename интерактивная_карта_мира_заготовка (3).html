<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Интерактивная карта — умный геокодинг</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { width: 100vw; height: 100vh; }
    #status {
      position: fixed;
      left: 10px;
      bottom: 10px;
      background: rgba(0,0,0,0.75);
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 1000;
      max-width: 90vw;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div id="status">Инициализация…</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
/********************************************************
 * НАСТРОЙКИ
 ********************************************************/
const SHEET_GVIZ_URL = "https://docs.google.com/spreadsheets/d/1BItr9-Q8qnN0S05sMh1YLMqCCfXuNm1E88dvpGkVNU0/gviz/tq?tqx=out:json";
const MAX_ADDRESSES = 100;
const GEOCODE_DELAY = 600;

/********************************************************
 * КАРТА
 ********************************************************/
const map = L.map('map').setView([55, 37], 4);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors'
}).addTo(map);

const markers = L.markerClusterGroup();
map.addLayer(markers);

const statusEl = document.getElementById('status');

/********************************************************
 * УТИЛИТЫ
 ********************************************************/
function sleep(ms) {
  return new Promise(r => setTimeout(r, ms));
}

function clean(str) {
  return (str || '')
    .toLowerCase()
    .replace(/\n/g, ' ')
    .replace(/г\.|город|обл\.|область|р-н|район|ул\.|улица|д\.|дом/g, ' ')
    .replace(/[^a-zа-я0-9 ,.-]/gi, ' ')
    .replace(/\s+/g, ' ')
    .trim();
}

function splitAddress(full, region) {
  // Адреса в таблице идут сверху вниз: область → город → улица → дом
  const reg = clean(region);
  const base = clean(full);

  const parts = base.split(',').map(p => p.trim()).filter(Boolean);

  const city = parts[0] || '';
  const street = parts[1] || '';
  const house = parts[2] || '';

  const attempts = [];

  // 1. область → город → улица → дом
  attempts.push(`${reg}, ${city}, ${street}, ${house}, россия`);

  // 2. область → город → улица
  if (street) {
    attempts.push(`${reg}, ${city}, ${street}, россия`);
  }

  // 3. область → город
  if (city) {
    attempts.push(`${reg}, ${city}, россия`);
  }

  // 4. только область
  attempts.push(`${reg}, россия`);

  return [...new Set(attempts.filter(Boolean))];
}

async function geocodeSmart(addressVariants) {
  for (const query of addressVariants) {
    const url = `https://photon.komoot.io/api/?limit=1&q=${encodeURIComponent(query)}`;
    try {
      const res = await fetch(url);
      if (!res.ok) continue;
      const data = await res.json();
      if (data.features && data.features.length) {
        const f = data.features[0];
        return {
          lat: f.geometry.coordinates[1],
          lon: f.geometry.coordinates[0],
          query
        };
      }
    } catch (_) {}
  }
  return null;
}

/********************************************************
 * ЗАГРУЗКА ДАННЫХ
 ********************************************************/
(async function init() {
  try {
    statusEl.textContent = 'Загрузка таблицы…';

    const res = await fetch(SHEET_GVIZ_URL);
    if (!res.ok) throw new Error('GVIZ error');

    const text = await res.text();
    const json = JSON.parse(text.substring(47, text.length - 2));
    const rows = json.table.rows;

    let processed = 0;
    let placed = 0;

    for (const r of rows) {
      if (processed >= MAX_ADDRESSES) break;

      const region = r.c[1]?.v;
      const full = r.c[2]?.v;
      if (!full || !region) continue;

      processed++;
      statusEl.textContent = `Геокодинг ${processed}/${MAX_ADDRESSES}`;

      const variants = splitAddress(full, region);
      const geo = await geocodeSmart(variants);

      if (geo) {
        markers.addLayer(
          L.marker([geo.lat, geo.lon]).bindPopup(`
            <b>Адрес:</b><br>${full}<br><br>
            <b>Запрос:</b><br>${geo.query}
          `)
        );
        placed++;
      }

      await sleep(GEOCODE_DELAY);
    }

    statusEl.textContent = `Готово: ${placed} из ${processed} адресов размещены`;

  } catch (e) {
    console.error(e);
    statusEl.textContent = 'Ошибка загрузки данных';
  }
})();
</script>
</body>
</html>
