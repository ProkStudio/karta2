<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Интерактивная карта из Google Sheets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { width: 100vw; height: 100vh; }
  </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/********************************************************
 * НАСТРОЙКИ
 ********************************************************/
// CSV-экспорт Google Sheets (таблица должна быть доступна по ссылке)
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1BItr9-Q8qnN0S05sMh1YLMqCCfXuNm1E88dvpGkVNU0/export?format=csv";

// Задержка между запросами геокодинга (ВАЖНО для Nominatim)
const GEOCODE_DELAY = 1200; // мс

/********************************************************
 * КАРТА
 ********************************************************/
const map = L.map('map').setView([20, 0], 2);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors'
}).addTo(map);

/********************************************************
 * УТИЛИТЫ
 ********************************************************/
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// Простейшая нормализация «кривых» адресов
function normalizeAddress(raw) {
  if (!raw) return '';
  return raw
    .replace(/\n/g, ' ')
    .replace(/\s+/g, ' ')
    .replace(/,/g, ' ')
    .trim();
}

async function geocode(address) {
  const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(address)}`;

  const res = await fetch(url, {
    headers: {
      // ОБЯЗАТЕЛЬНО по правилам Nominatim
      'User-Agent': 'MapDemo/1.0 (contact@example.com)'
    }
  });

  const data = await res.json();
  if (!data || !data.length) return null;

  return {
    lat: parseFloat(data[0].lat),
    lon: parseFloat(data[0].lon),
    display: data[0].display_name
  };
}

/********************************************************
 * ЗАГРУЗКА ДАННЫХ ИЗ GOOGLE SHEETS
 ********************************************************/
fetch(SHEET_CSV_URL)
  .then(res => res.text())
  .then(async csv => {
    const rows = csv.split('\n').map(r => r.split(','));

    // предполагаем, что адрес в первой колонке
    const header = rows.shift();

    for (const row of rows) {
      const rawAddress = row[0];
      if (!rawAddress) continue;

      const address = normalizeAddress(rawAddress);

      try {
        const geo = await geocode(address);
        if (!geo) continue;

        L.marker([geo.lat, geo.lon])
          .addTo(map)
          .bindPopup(`
            <b>Исходный адрес:</b><br>${rawAddress}<br><br>
            <b>Найдено:</b><br>${geo.display}
          `);

        await sleep(GEOCODE_DELAY);
      } catch (e) {
        console.error('Ошибка геокодинга:', address, e);
      }
    }
  });
</script>
</body>
</html>
